name: Auto response

on:
  issues:
    types: [labeled]
  pull_request_target:
    types: [labeled]

permissions:
  issues: write
  pull-requests: write

jobs:
  auto-response:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1
        id: app-token
        with:
          app-id: "2729701"
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - name: Handle labeled items
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // Labels prefixed with "r:" are auto-response triggers.
            const rules = [
              {
                label: "r: skill",
                close: true,
                message:
                  "Thanks for the contribution! New skills should be published as community extensions. We're keeping the core lean on skills, so I'm closing this out.",
              },
              {
                label: "r: support",
                close: true,
                message:
                  "Please join our Discord at https://discord.gg/thinkfleet and ask in #help to resolve this, or check the docs at https://docs.thinkfleet.dev/help/faq.",
              },
              {
                label: "r: third-party-extension",
                close: true,
                message:
                  "This would be better made as a third-party extension with our plugin SDK that you maintain yourself. Docs: https://docs.thinkfleet.dev/plugin-sdk.",
              },
            ];

            const labelName = context.payload.label?.name;
            if (!labelName) {
              return;
            }

            const rule = rules.find((item) => item.label === labelName);
            if (!rule) {
              return;
            }

            const issueNumber = context.payload.issue?.number ?? context.payload.pull_request?.number;
            if (!issueNumber) {
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: rule.message,
            });

            if (rule.close) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: "closed",
              });
            }
